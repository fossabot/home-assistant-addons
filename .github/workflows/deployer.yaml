---
name: Deployer

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
    inputs:
      addon:
        description: Addon-Name
        required: true
        type: string
  workflow_call:
    inputs:
      addon:
        description: Addon-Name
        required: true
        type: string

# Prevent multiple releases of the same add-on from running simultaneously
concurrency:
  group: release-${{ inputs.addon }}
  cancel-in-progress: false

# Set default permissions for all jobs
permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  init:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    name: Prepare ${{ inputs.addon }} Release
    outputs:
      release_name: ${{ steps.release_notes.outputs.name }}
      release_version: ${{ steps.values.outputs.release_version }}
      architectures: ${{ steps.info.outputs.architectures }}
      image: ${{ steps.values.outputs.image }}
    steps:
      - name: Check out the repository
        uses: actions/checkout@v4.3.1
      - name: Validate add-on exists
        run: |
          if [ ! -d "${{ inputs.addon }}" ]; then
            echo "Error: Add-on '${{ inputs.addon }}' not found"
            exit 1
          fi
          if [ ! -f "${{ inputs.addon }}/config.yaml" ]; then
            echo "Error: config.yaml not found for '${{ inputs.addon }}'"
            exit 1
          fi
      # Note: Using @master for home-assistant/actions helpers as the repo has no proper version tags
      # (only v1.0.0 from 2020). The helpers are actively maintained on the master branch.
      - name: Find add-on directories
        id: addons
        uses: home-assistant/actions/helpers/find-addons@master
      - name: Get add-on information
        id: info
        uses: home-assistant/actions/helpers/info@master
        with:
          path: "./${{ inputs.addon }}"
      - name: Run Release Drafter
        uses: release-drafter/release-drafter@v6.2.0
        id: release_notes
        with:
          config-name: "release-drafter-${{ inputs.addon }}.yml"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Generate Build Values
        id: values
        run: |
          date="$(date +"%Y-%m-%dT%H:%M:%SZ")"
          version="${{ steps.release_notes.outputs.tag_name }}"
          version="${version##*-}"

          echo "Add-on: ${{ inputs.addon }} Version: $version Date: $date"
          echo "release_date=$date" >> $GITHUB_OUTPUT
          echo "release_version=$version" >> $GITHUB_OUTPUT
          echo "image=$(echo ${{ steps.info.outputs.image }} | cut -d'/' -f3)" >> $GITHUB_OUTPUT
      - name: Update Config Files
        run: |
          echo "Updating version in config.yaml"
          yq -i '.version = "${{ steps.values.outputs.release_version }}"' "${{ inputs.addon }}/config.yaml"
          head "${{ inputs.addon }}/config.yaml"

          echo "Adding Docker Labels in build.yaml"
          yq -i '
            .labels."org.opencontainers.image.title" = "Home Assistant Unofficial Add-on: ${{ inputs.addon }}" |
            .labels."org.opencontainers.image.url" = "https://github.com/${{ github.repository }}" |
            .labels."org.opencontainers.image.source" = "https://github.com/${{ github.repository }}/${{ inputs.addon }}" |
            .labels."org.opencontainers.image.documentation" = "https://github.com/${{ github.repository }}/${{ inputs.addon }}/README.md" |
            .labels."org.opencontainers.image.created" = "${{ steps.values.outputs.release_date }}" |
            .labels."org.opencontainers.image.revision" = "${{ github.sha }}" |
            .labels."org.opencontainers.image.version" = "${{ steps.values.outputs.release_version }}"
          ' "${{ inputs.addon }}/build.yaml"
          cat "${{ inputs.addon }}/build.yaml"
      - name: Update CHANGELOG.md
        uses: stefanzweifel/changelog-updater-action@v1.12.0
        id: update_changelog
        with:
          latest-version: ${{ steps.release_notes.outputs.name }}
          release-notes: ${{ steps.release_notes.outputs.body }}
          path-to-changelog: ${{ inputs.addon }}/CHANGELOG.md
      - name: Upload Release Artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: release-files
          path: ${{ inputs.addon }}

  build:
    timeout-minutes: 60
    needs: init
    runs-on: ubuntu-latest
    name: Build ${{ matrix.arch }}
    strategy:
      fail-fast: true
      matrix:
        arch: ${{ fromJson(needs.init.outputs.architectures) }}
    steps:
      - name: Download Release Artifacts
        uses: actions/download-artifact@v4.3.0
        with:
          name: release-files
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build ${{ inputs.addon }} add-on
        uses: home-assistant/builder@2024.08.2
        with:
          args: |
            --${{ matrix.arch }} \
            --target /data/${{ inputs.addon }} \
            --image "${{ needs.init.outputs.image }}" \
            --docker-hub "ghcr.io/${{ github.repository_owner }}" \
            --addon

  release:
    timeout-minutes: 10
    needs: ["init", "build"]
    runs-on: ubuntu-latest
    name: Release ${{ needs.init.outputs.release_name }}
    steps:
      - name: Check out the repository
        uses: actions/checkout@v4.3.1
        with:
          fetch-depth: 0
      - name: Download Release Artifacts
        uses: actions/download-artifact@v4.3.0
        with:
          name: release-files
      - name: Copy updated files from artifacts
        run: |
          # Copy updated config files from artifacts to working directory
          cp -r ${{ inputs.addon }}/config.yaml ${{ inputs.addon }}/config.yaml
          cp -r ${{ inputs.addon }}/build.yaml ${{ inputs.addon }}/build.yaml
          if [ -f "${{ inputs.addon }}/CHANGELOG.md" ]; then
            cp -r ${{ inputs.addon }}/CHANGELOG.md ${{ inputs.addon }}/CHANGELOG.md
          fi
      - name: Update README.md
        uses: ./.github/actions/update-readme
        with:
          addons: ${{ inputs.addon }}
      - name: Commit new Addon Config
        uses: stefanzweifel/git-auto-commit-action@v5.2.0
        with:
          commit_message: Released ${{ needs.init.outputs.release_name }}
          commit_user_email: actions@github.com
      - name: Create Release
        uses: release-drafter/release-drafter@v6.2.0
        with:
          config-name: "release-drafter-${{ inputs.addon }}.yml"
          publish: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
